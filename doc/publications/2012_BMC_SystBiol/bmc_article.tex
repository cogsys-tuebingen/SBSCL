%% BioMed_Central_Tex_Template_v1.06
%%                                      %
%  bmc_article.tex            ver: 1.06 %
%                                       %

%%IMPORTANT: do not delete the first line of this template
%%It must be present to enable the BMC Submission system to 
%%recognise this template!!

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                     %%
%%  LaTeX template for BioMed Central  %%
%%     journal article submissions     %%
%%                                     %%
%%         <14 August 2007>            %%
%%                                     %%
%%                                     %%
%% Uses:                               %%
%% cite.sty, url.sty, bmc_article.cls  %%
%% ifthen.sty. multicol.sty		   %%
%%				      	   %%
%%                                     %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                                                 %%	
%% For instructions on how to fill out this Tex template           %%
%% document please refer to Readme.pdf and the instructions for    %%
%% authors page on the biomed central website                      %%
%% http://www.biomedcentral.com/info/authors/                      %%
%%                                                                 %%
%% Please do not use \input{...} to include other tex files.       %%
%% Submit your LaTeX manuscript as one .tex document.              %%
%%                                                                 %%
%% All additional figures and files should be attached             %%
%% separately and not embedded in the \TeX\ document itself.       %%
%%                                                                 %%
%% BioMed Central currently use the MikTex distribution of         %%
%% TeX for Windows) of TeX and LaTeX.  This is available from      %%
%% http://www.miktex.org                                           %%
%%                                                                 %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\documentclass[10pt]{bmc_article}    



% Load packages
\usepackage{cite} % Make references as [1-4], not [1,2,3,4]
\usepackage{url}  % Formatting web addresses  
\usepackage{ifthen}  % Conditional 
\usepackage{multicol}   %Columns
\usepackage[utf8]{inputenc} %unicode support
%\usepackage[applemac]{inputenc} %applemac support if unicode package fails
%\usepackage[latin1]{inputenc} %UNIX support if unicode package fails
\urlstyle{rm}
 
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%	
%%                                             %%
%%  If you wish to display your graphics for   %%
%%  your own use using includegraphic or       %%
%%  includegraphics, then comment out the      %%
%%  following two lines of code.               %%   
%%  NB: These line *must* be included when     %%
%%  submitting to BMC.                         %% 
%%  All figure files must be submitted as      %%
%%  separate graphics through the BMC          %%
%%  submission process, not included in the    %% 
%%  submitted article.                         %% 
%%                                             %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                     


\def\includegraphic{}
\def\includegraphics{}



\setlength{\topmargin}{0.0cm}
\setlength{\textheight}{21.5cm}
\setlength{\oddsidemargin}{0cm} 
\setlength{\textwidth}{16.5cm}
\setlength{\columnsep}{0.6cm}

\newboolean{publ}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                              %%
%% You may change the following style settings  %%
%% Should you wish to format your article       %%
%% in a publication style for printing out and  %%
%% sharing with colleagues, but ensure that     %%
%% before submitting to BMC that the style is   %%
%% returned to the Review style setting.        %%
%%                                              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 

%Review style settings
%\newenvironment{bmcformat}{\begin{raggedright}\baselineskip20pt\sloppy\setboolean{publ}{false}}{\end{raggedright}\baselineskip20pt\sloppy}

%Publication style settings
%\newenvironment{bmcformat}{\fussy\setboolean{publ}{true}}{\fussy}

%New style setting
\newenvironment{bmcformat}{\baselineskip20pt\sloppy\setboolean{publ}{false}}{\baselineskip20pt\sloppy}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  Customized tags and styles
%
\usepackage{hyperref}
\usepackage{listings}
\usepackage[english]{babel}
%\usepackage[normalem]{ulem}
\usepackage{xcolor}

\hyphenation{
  % TODO hypens for regular words
  im-ple-men-ta-tions
  gra-phi-cal
  bench-mark-ed
}

% some nice colors
\definecolor{royalblue}{cmyk}{.93, .79, 0, 0}
\definecolor{lightblue}{cmyk}{.10, .017, 0, 0}
\definecolor{forrestgreen}{cmyk}{.76, 0, .76, .45}
\definecolor{darkred}{rgb}{.7,0,0}
\definecolor{winered}{cmyk}{0,1,0.331,0.502}
\definecolor{lightgray}{gray}{0.97}

\newcommand{\TODO}[1]{\textcolor{red}{\textbf{#1}}}
\newcommand{\AbstractDESSolver}{\texttt{Abstract\-DES\-Solver}}
\newcommand{\OverdeterminationValidator}{\texttt{Overdetermination\-Validator}}
\newcommand{\SBMLinterpreter}{\texttt{SBML\-interpreter}}
\newcommand{\FirstOrderSolver}{\texttt{First\-Order\-Solver}}
\newcommand{\AbstractIntegrator}{\texttt{AbstractIntegrator}}
\newcommand{\MultiTable}{\texttt{Multi\-Table}}
\newcommand{\Block}{\texttt{Block}}
\newcommand{\jlibsedml}{\texttt{jlibsedml}}
\newcommand{\EventInProgress}{\texttt{Event\-In\-Progress}}
\newcommand{\SBMLEventInProgressWithDelay}{\texttt{SBML\-Event\-In\-Progress\-With\-Delay}}

% the derivative symbol for differential equations
\newcommand{\D}{\mathrm{d}}


\lstset{language=Java,
morendkeywords={String, Throwable}
captionpos=b,
basicstyle=\scriptsize\ttfamily,%\bfseries
stringstyle=\color{darkred}\scriptsize\ttfamily,
keywordstyle=\color{royalblue}\bfseries\ttfamily,
ndkeywordstyle=\color{forrestgreen},
numbers=left,
numberstyle=\scriptsize,
% backgroundcolor=\color{lightgray},
breaklines=true,
tabsize=2,
frame=single,
breakatwhitespace=true,
identifierstyle=\color{black},
% morecomment=[l][\color{forrestgreen}]{//},
% morecomment=[s][\color{lightblue}]{/**}{*/},
% morecomment=[s][\color{forrestgreen}]{/*}{*/},
commentstyle=\ttfamily\itshape\color{forrestgreen}
% framexleftmargin=5mm,
% rulesepcolor=\color{lightgray}
% frameround=ttff
}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Begin ...
\begin{document}
\begin{bmcformat}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the title of your article here     %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{The Simulation Core Algorithm and its implementation for numerical
computation in systems biology}
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the authors here                   %%
%%                                          %%
%% Ensure \and is entered between all but   %%
%% the last two authors. This will be       %%
%% replaced by a comma in the final article %%
%%                                          %%
%% Ensure there are no trailing spaces at   %% 
%% the ends of the lines                    %%     	
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\author{%
Roland Keller$^{1}$\correspondingauthor\email{Roland Keller -
roland.keller@uni-tuebingen.de}, 
Alexander D\"orr$^{1}$\correspondingauthor\email{Alexander D\"orr -
alexander.doerr@uni-tuebingen.de},  
Akito Tabira$^{2}$, %\email{Akito Tabira - mythosil_full_throttle@i.softbank.jp}
Akira Funahashi$^{2}$, %\email{Akira Funahashi - funa@bio.keio.ac.jp}
Michael J. Ziller$^{3}$, %\email{Michael J. Ziller - michael_ziller@harvard.edu}
Richard Adams$^{4}$, %\email{Richard Adams - richard.adams@ed.ac.uk}
Nicolas Rodriguez$^{5}$, %\email{Nicolas Rodriguez - rodrigue@ebi.ac.uk}
Nicolas Le Nov\`{e}re$^{5}$, %\email{Nicolas Le Nov\`{e}re - nicolas.lenovere@babraham.ac.uk}
Hannes Planatscher$^{6}$, %\email{Hannes Planatscher - Hannes.Planatscher@nmi.de}
Andreas Zell$^{1}$, %\email{Andreas Zell - andreas.zell@uni-tuebingen.de}
and Andreas Dr\"ager$^{1}$\correspondingauthor\email{Andreas Dr\"ager -
andreas.draeger@uni-tuebingen.de}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% Enter the authors' addresses here        %%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\address{%
\iid(1)Center for Bioinformatics Tuebingen (ZBIT), University of
Tuebingen, T\"ubingen, Germany
\iid(2)Keio University, Graduate School of
Science and Technology, Yokohama, Japan 
\iid(3)Department of Stem Cell and Regenerative Biology, Harvard University,
Cambridge, MA, USA
\iid(4)SynthSys Edinburgh, CH Waddington Building, University of Edinburgh,
Edinburgh EH9 3JD, UK
\iid(5)European Bioinformatics Institute, Wellcome Trust Genome Campus, Hinxton,
Cambridge, UK
\iid(6)Natural and Medical Sciences Institute at the University of Tuebingen,
Reutlingen, Germany}

\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The Abstract begins here                 %%
%%                                          %%  
%% Please refer to the Instructions for     %%
%% authors on http://www.biomedcentral.com  %%
%% and include the section headings         %%
%% accordingly for your article type.       %%   
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{abstract}
        % Do not use inserted blank lines (ie \\) until main body of text.
Dynamic simulation of biological phenomena is a the key aspect of
research in systems biology. However, it is often difficult to use available
implementations of numerical methods as a backend for custom-made programs.

The Simulation Core Library is a community-driven project that provides a large
collection of numerical solvers and a sophisticated interface hierarchy for the
definition of custom differential equation systems. It is entirely
implemented in Java\texttrademark{} without the necessity to
include any platform-dependent wrappers or libraries, and does not depend on
any commercial licenses.
%, and can be used on every operating system for which a JVM
%is available.
It already includes an efficient and exhaustive implementation of methods to
interpret the content of models encoded in SBML using the JSBML project.
To demonstrate its capabilities, it has been tested with the
entire SBML Test Suite and %also been used to simulate 
all models of BioModels Database.
Source code, binaries, and documentation can be freely obtained under the terms
of the LGPL version~3 from the website
\href{http://sourceforge.net/projects/simulation-core/}{http://sourceforge.net/projects/simulation-core/}.

Contact:
\href{mailto:simulation-core-development@lists.sourceforge.net}{simulation-core-development@lists.sourceforge.net}
%
%\section{Supplementary information:}
% TODO: Provide additional material
%Supplementary data is available at Bioinformatics online.     
\end{abstract}



\ifthenelse{\boolean{publ}}{\begin{multicols}{2}}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                                          %%
%% The Main Body begins here                %%
%%                                          %%
%% Please refer to the instructions for     %%
%% authors on:                              %%
%% http://www.biomedcentral.com/info/authors%%
%% and include the section headings         %%
%% accordingly for your article type.       %% 
%%                                          %%
%% See the Results and Discussion section   %%
%% for details on how to create sub-sections%%
%%                                          %%
%% use \cite{...} to cite references        %%
%%  \cite{koon} and                         %%
%%  \cite{oreg,khar,zvai,xjon,schn,pond}    %%
%%  \nocite{smith,marg,hunn,advi,koha,mouse}%%
%%                                          %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%
%% Background %%
%%
\section*{Background}

\TODO{More explanation why this is needed and comparison to other existing
approaches.}

As part of the movement towards quantitative biology, modeling, 
simulation, and computer analysis of biological networks have become integral
parts of modern biological research. Ambitious national and international
research projects such as the Virtual Liver Network \cite{Holzhuetter2012}
strive to derive even organ-wide models of biological systems that include all
kinds of processes taking place at several levels of detail. Large-scale efforts
like this require a strong collaboration between various research groups,
including experimenters and modelers. The exchange, storage, interoperability
and the possibility to combine models have been recognized as key aspects of
this endeavor \cite{Liebermeister2009sta}.

XML-based standard description formats \cite{Bray2000} such as the Systems
Biology Markup Language (SBML, \cite{Hucka2004}) or CellML \cite{Lloyd2004}
enable encoding of quantitative biological network models.
To facilitate sharing and reuse of the models, online data bases such as the
BioModels database \cite{Novere2006a} or the CellML model repository
\cite{Lloyd2008} provide large collections of published models in various
formats.
Software libraries for reading and manipulating the content
of these formats are also available \cite{Bornstein2008, Miller2010,
Draeger2011b} and a large variety of programs supports these model formats.

\TODO{Describe and cite genome-scale models and their size. Can our solver also
work with large-scale models such as HepatoNet1?}

The models encoded in these formats can be interpreted in terms of differential
equation systems, with additional structures such as discrete events and
algebraic equations. 
For efficient model analysis, simulation, and calibration (e.g.,
the estimation of parameter values) multiple-purpose and efficient numerical
solver library that has been designed with the requirements of biological
network models in mind is prerequisite.
Althought the language specifications of SBML \cite{Hucka2001, Hucka2003,
Finney2003a, Finney2006, Hucka2007, Hucka2008, Hucka2010a} 
and CellML \cite{Cuellar2006} describe the semantics of models in these formats
and their interpretation, the algorithmic implementation is still not
straightforward. 

Both communities offer standardized and manually derived benchmark test in order
to evaluate the quality of simulation results, because it has been recognized that in many cases
different solver implementations lead to divergent results \cite{Bergmann2008}.

In this work we address the question of how to precisely solve models encoded in
the SBML format, supporting all levels and versions. To this end, we here
describe a precise solver algorithm. As a reference implementation, we
introduce an exhaustive implementation in the Java\texttrademark{} programming
language. The algorithm described in this paper is, however, not limited to any
particular programing language. It is also important to note that the
interpretation of these models must be strictly separated from the numerical
method that solves the implicated differential equation system. In this way, a
similar approach can also be done for CellML.

%
%The modeling language SBML (Systems Biology Markup Language,
%\cite{Hucka2003}) constitutes an important \emph{de facto} standard for the
%exchange of biochemical network models.
%SBML defines a set of data structures and provides rules about how to interpret
%and simulate these kinds of models.
%
%Models in systems biology may combine an ordinary differential equation system,
%which is the basis for numerical simulation, with additional elements such as
%rules and events.  These elements further influence the system. 
%For instance,
%an event takes place if a certain trigger condition becomes true. Whenever this
%happens, event assignments may change the values of model components, such as
%parameter values or compartment sizes. Rules can directly assign new values to
%their objectives, e.g., the concentration of a reacting species.
%
%
The Simulation Core Library presented here is a platform-independent,
well-tested alternative.
This generic library is completely decoupled from any graphical user interface
and can therefore easily be integrated into third-party programs.
It comprises several Ordinary Differential Equation (ODE)
solvers and an interpreter for SBML models. It is the first simulation library
based on JSBML \cite{Draeger2011b}. 
% the Java library JSBML 
%
%Secondly, a graphical and command-line user interface that provides
%a connection to the heuristic optimization framework EvA2 \cite{Kron10EvA2}.
% The combination of SBMLsimulator and EvA2 \cite{Kron10EvA2} estimates the values of all parameters with
%respect to given time-series of metabolite or gene expression values. 
%
Furthermore, the Simulation Core Library contains classes to both export
simulation configurations to SED-ML (Simulation Experiment Description Markup Language,
\cite{Waltemath2011}), and facilitate the re-use and reproduction of these
experiments by executing SED-ML files.

\section{Results and discussion}

\TODO{Describe SBML solving algorithm}

The mathematical structure of a reaction network comprises a stoichiometric
matrix $\mathbf{N}$, whose rows correspond to the reacting species $\vec{S}$
within the system, whereas its columns represent the reactions, i.e., bio-transformations,
in which these species participate.
The velocities $\vec{\nu}$ of the reactions $\vec{R}$ determine the rate of
change of the species' amounts:
\begin{equation}
\frac{\D}{\D t}\vec{S} = \mathbf{N}\vec{\nu}(\vec{S}, t, \mathbf{W}, \vec{p})\,.
\label{eq:SpeciesChange}
\end{equation}
The parameter vector $\vec{p}$ contains rate constants and other, often
constant, quantities that influence the reaction velocities.
According to \cite{Liebermeister2006, Liebermeister2010} the modulation matrix
$\mathbf{W}$ is defined as a matrix of size $|\vec{R}|\times|\vec{S}|$
containing the type of the regulatory influences of the species on
the reactions, e.g., competetive inhibition or physical stimulation.
Integrating Equation~\ref{eq:SpeciesChange} yields the predicted amounts of the
species at each time point of interest within the interval $[t_0, t_T]$:
\begin{equation}
\vec{S} = \int_{t_0}^{t_T} \mathbf{N}\vec{\nu}(\vec{S}, t, \mathbf{W}, \vec{p})
\D t\,.
\end{equation}
\TODO{The result of this integral is not a vector, but some kind of matrix
(because of the time interval). How can this be formalized correctly?}
Depending on the units of the species, the same notation can also express the
change of the species' concentrations.
In this simple case, solving the homogeneous ordinary
differential equation system~\ref{eq:SpeciesChange} can be done in a
straightforward way using many (numerical) differential equation solvers.
The non-linear form of the kinetic equations in the vector function $\vec{\nu}$
constitute the major difficulty for this endeavor and are often the reason why
an analytical solution of these systems is not possible or very hard to achieve.
Generally, differential equation systems describing biological networks are,
however, inhomogenious systems with a higher complexity.
Systems encoded in SBML can be seen as
\begin{equation}
\vec{Q} = \int_{t_0}^{t_T} \mathbf{N}\vec{\nu}(\vec{Q}, t, \mathbf{W},
\vec{p})\D t + \int_{t_0}^{t_T} \vec{g}(\vec{Q})\D t + \vec{e}(\vec{Q}) + \vec{r}(\vec{Q})\,.
\label{eq:QuantityValue}
\end{equation}
The vector $\vec{Q}$ of quantities contains the sizes of the
compartments $\vec{C}$, amounts (or concentrations) of reacting species
$\vec{S}$, and the values of all global model parameters $\vec{P}$.
It should be noted that these models may contain local parameters $\vec{p}$ that
influence the reaction velocities, but which are not part of the global parameter
vector $\vec{P}$, and hence part of $\vec{Q}$.
In the general case of Equation~\ref{eq:QuantityValue}, not all species' amounts
can be computed by integrating the transformation $\mathbf{N}\vec{\nu}$: The
change of some model quantities may be given in form of rate rules (function
$\vec{g}(\vec{Q})$) that must be integrated separately.
Species, whose amounts are determined by rate rules, must not participate in any
reaction and do hence not have a corresponding entry in the stoichiometric
matrix $\mathbf{N}$.
Thereby, a rate rule directly gives the rate of change of some quantity:
\begin{equation}
\frac{\D}{\D t}\vec{Q} = g(\vec{Q})\,.
\end{equation}
In addition, SBML introduces the concept of events $\vec{e}(\vec{Q})$ and
$\vec{r}(\vec{Q})$ assignment rules.
An event can directly manipulate the value of a quantity, for instance,
set the size of a certain compartment to half of its current size, as soon as a
trigger condition becomes satisfied.
An assignment rule also influences the absolute value of some model.
A further concept of SBML models are algebraic rules, which are equations that
must be evaluated to zero at all times during the simulation of the model.
These rules can be solved to determine the values of quantities, whose values
are not determined by other constructs.
In this way, conservation relations or other complex interrelations can be
expressed in a very convenient way.
With the help of a bipartite matching and a subsequent conversion it is possible
to turn algebraic rules into assignment rules and hence include these into the
term $\vec{r}(\vec{Q})$.
Such a transformation, however, requires symbolic computation and is
hence a complicated endeavor.
In case that the system under study operates at multiple time scales, i.e., it
contains a fast and a slow sub-system, a separation of the system is necessary
leading to differential algebraic equations.
Solving Equation~\ref{eq:QuantityValue} is therefore much more complicated than
computing the solution of the simple Equation~\ref{eq:SpeciesChange} alone.
It should be noted that a strict separation of the interpretation of the model
and the numerical treatment of the differential equation system is necessary to
ensure that regular numerical methods can be used to solve
Equation~\ref{eq:QuantityValue}.
In order to efficiently compute this solution, multiple pre-processing steps are
required, such as the conversion of algebraic rules into assignment rules, or
avoiding repeated re-computation of intermediate results.
The next sections will give a detailed explanation of the necessary steps to
solve these systems and how to perform their numerical integration with standard
numerical solvers.


\subsection{Initialization}

At the beginning of the simulation the values of species, parameters and
compartments are set to the initial values given in the model.
The initial values can also be set later by initial assignments or rules.
All kinetic laws of the reactions, assignment rules, transformed algebraic
rules (see below), initial assignments, event assignment rules and rate rules
are integrated into a directed acyclic syntax graph.
This graph is then a merging of the abstract syntax trees of all those elements.
Equivalent elements are only contained once.
This significantly decreases the computation time during the simulation.

After the creating of the abstract syntax graph, the initial assignments, the
assignment rules (including transformed algebraic rules) are processed.
So the initial values that are given in rules are also set now.


\subsection{Solving algebraic rules}
In order to deal with algebraic rules in a SBML model, they have to be rewritten in terms
of assignment rules. In every equation of an algebraic rule, there should be at least one variable, 
whose value is not yet defined through other elements in model. This variable has to be determined 
for the purpose of interpreting the regarding algebraic rule.
At first a bipartite graph according to the SBML specifications is generated. This graph is used to 
compute a matching, using the algorithm from Hopcroft and Karp
\cite{hopcroft1973n}. The initial greedy matching is extended with the use of augmenting paths. This process is
repeated until no more augmenting paths can be found. Per definition, this results in a maximal matching. 
As stated in the SBML specifications, if any equation vertex remains unconnected after augmenting the 
matching as far as possible, the model is considered overdetermined and thus is not a valid SBML model. 
But if we are indeed looking at a valid SBML model, every assignment rule is converted into an algebraic rule. 
Therefor the MathML expression in SBML is transformed into an equation with a left-hand side. The left-hand 
side is represented by the respective variable vertex the considered algebraic rule has been matched to.


\subsection{Event handling}
With the release of SBML Level 3 Version 1, the processing of event has been raised to a higher level of 
complexity. Before 3.1 it was sufficient to determine, when an events triggers and when it is performed 
due to a possible delay. Since 3.1, only some language elements have been added but with an huge 
influence on the handling of events. Therefore the crucial part is now to coordinate the execution of events. 
The order in which events have been processed used to be at programmers discretion, but now it is given 
by the event's priority. Furthermore there exists the option to cancel an event during the interval its trigger 
has been activated and the time the scheduler picks the event for execution. 

For every time step, the events to be executed are a union of two subsets of the set containing all events.
On the one hand there are the events whose trigger has been activated at the given time and are without delay. On the other hand there are events that triggered at some time point before and whose delay reaches till the current point in time. For every element of the resulting set of events the priority is evaluated.
An event with the highest priority is randomly chosen to be executed. All other events
could be handled in the same manner. However, the assignment of the first event can change the priority or even the trigger of the events that have not been executed yet. Therefore the trigger of non persistent 
events and the priority of the remaining events have to be evaluated again and another event with the highest priority is chosen. This process repeats itself until no further events to be executed are left.

\subsection{Calculation of the derivatives for a certain time point}
For given values $x$ at a time point the curring vector of derivatives is calculated as follows: First all derivatives in the vector $x'$ are set to zero. Then the rate rules are processed, which can change $x'$. After that for each reaction the velocity, which depends on $x$, is computed with the help of the syntax graph. Then the derivatives of all species that participate in the current reaction need to be updated.

\subsection{Integrated calculation for a certain time step including event processing}
The Rosenbrock solver is the solver that can adapt its step size if events are happening. For a certain time begin and time end and a vector $x$ it determines a new vector at a time point that is determined by the current adaptive step size. It refers to the already described calculation of the derivatives for a certain time point in this step.

After that the events and the assignment rules are processed at the new time point. If this last step causes a change in $x$, the adaptive step size is decreased and the calculation is repeated until the minimum step size is reached or the processing of events and rules does not change $x$ any more. So the time at which an event happens is precisely determined.

\TODO{Discuss implementation in Java}
%Why no heap is used for events 

\subsection{Application to published models}

Biomodel 206 \cite{Wolf2000}
Biomodel 390 \cite{Arnold2011}

\subsection{Comparison to existing solvers}

Many stand-alone programs providing these features come with
graphical user interfaces.
For instance, the Virtual Cell \cite{Loew2001}, iBioSim \cite{Myers2009},
PottersWheel \cite{Maiwald2008}, COPASI \cite{Hoops2006}, SBToolbox2
\cite{SBT_Schmidt2006}, or the Systems Biology Workbench with Roadrunner (SBW, \cite{Bergmann06}). 
However, the vast majority of the internal solvers for these systems are part of
larger software suites and can therefore not be easily integrated into custom
programs. Some are implemented in programming languages that are either
platform-dependent (e.g., C or C++) and/or require a commercial license (e.g.,
MATLAB\texttrademark{}) for their execution.
The SBML ODE Solver Library \cite{Machne2006}, which is written in C,
and based on the libSBML library \cite{Bornstein2008}, 
provides such a simulation routine based on the SUNDIALS differential equation
solver.

\section{Conclusions}
The SBML implementation has successfully passed the
SBML Test Suite (version 2.0.2).
%(see
%\href{http://sbml.org/Software/SBML_Test_Suite}{http://sbml.org/Software/SBML\_Test\_Suite}):
Furthermore, it solved 99.06\,\% of the models from the
\href{http://biomodels.net}{BioModels.net} database (release 23,
\cite{Novere2006a}).
Therefore, the Simulation Core Library is an efficient Java tool for the
simulation of differential equation systems used in systems biology. It can be
easily integrated in larger applications. For instance,
CellDesigner version~4.2 \cite{Funahashi2003} already uses it as one of its simulation libraries.
The stand-alone application SBMLsimulator (available at
\href{http://www.cogsys.cs.uni-tuebingen.de/software/SBMLsimulator}{http://www.cogsys.cs.uni-tuebingen.de/software/SBMLsimulator})
provides a convenient graphical user interface for the simulation of SBML
models and uses it as a computational backend.
The abstract class structure of the library supports the integration of
additional model formats, such as CellML, besides its SBML implementation. To
this end, it is only necessary to implement a suitable interpreter class.

%The SBML ODE Solver Library \cite{Machne2006}, which is written in C,
%and based on the libSBML library \cite{Bornstein2008}, 
%provides such a simulation routine based on the SUNDIALS differential equation
%solver.

By including support for the emerging standard SED-ML, we hope to facilitate the
exchange, archival and reproduction of simulation experiments performed using
the Simulation Core Library.

\section{Methods}

\subsection{Implementation}

\TODO{Keep Java-specific parts here, extract general algorithm to Results
section.}

All the solver classes are derived from the abstract class \AbstractDESSolver{}
(Fig.~1).
Several solvers of the Apache Commons Math library (version 3.0) are integrated
with the help of wrapper classes. Numerical methods and the actual differential
equation systems are strictly separated. The class \MultiTable{} stores the
results of a simulation within its \Block{} data structures. 
%
The abstract description of differential equation systems, with the help of
several distinct interfaces, makes possible to decouple them from a particular
type of biological network. It is therefore possible to pass an instance of an
interpreter for a respective model description format to any available solver.
%\marginpar{I would not quote SBML and CellML. CellML is
% actually not supported at the moment}
%
%A specialized interpreter class is required for the evaluation of a biological
%model. 
This interpretation is the most time consuming step of the integration procedure.
This is why efficient and clearly organized data structures are required to
ensure a high performance of the overall library. The interpretation of SBML
models is split between evaluation of events and rules, computation of
stoichiometric information, and computation of the current values for all model
components (such as species and compartments).
%
For a given state of the ODE system, the class \SBMLinterpreter{}, responsible
for the evaluation of models encoded in SBML returns the current set of
time-derivatives of the variables.
It is connected to an efficient MathML interpreter of the expressions contained
in kinetic laws, rules and events. The nodes of the syntax tree for those
expressions depend on the current state of the ODE system. If the state has
changed, the values of the nodes have to be recalculated.

%
An important aspect in the interpretation of SBML models is the
determination of the exact time at which an event occurs, as this influences
the precision of the system's variables. We therefore adjusted the Rosenbrock
solver \cite{Kotcon2011}, an integrator with an adaptive step size, to a very
precise timing of the events.
%\sout{Rosenbrock's method is well-suited even for stiff systems.}
%
Algebraic rules are turned into assignment rules before the
simulation: If the system is not overdetermined, the algebraic rule is converted into an assignment rule.
This will be done in the following way: A new object of the type \texttt{AssigmentRule} is generated, with the variable determined in the matching set as its variable. The MathML expression of this rule is created via the conversion of a copy of the algebraic rule's expression observing the results of the bipartite matching.
%\marginpar{This is only valid for polynomes. And for those,
%assignmentRules should have been used anyway. How do-you proceed for
%cos(x)=0?: Yes, that's true. People should use assignments there, but the
%AlgebraicRules in the test case are all of the type described here. I am
%currently not sure if we could solve cos(x) = 0 or similar cases.}
%

In the \SBMLinterpreter{} events are represented via an array containing an object of the class \EventInProgress{} for every event in the model. Thereby the distinction between events with and without delays is made. The major difference between both is that an event with delay can trigger multiple times before it is executed. In order to deal with this, the class \SBMLEventInProgressWithDelay{} keeps track of issue, with the help of a list containing the time points, at which this event has to executed. When events trigger more than once before execution, they have to be ordered according to their delay because the delay of the same event can vary.

When the \SBMLinterpreter{} is processing events with priority, the events with the highest priority 
are currently stored in list until one of them is selected for execution. One could argue, that all events can
be kept in the same data structure, e.\,g. in a binary max heap, where after the extraction of the element with the largest value, the heap is restructured so that that next largest value is at the top. As stated
in a previous section, the execution of one event can influence the priority off the remaining events. Considering the binary max heap, there is the possibility that many priorities change whereby the standard
method to restore the max heap characteristic after extraction is not sufficient any more. Therefore we disregarded the use of other data structures for now.
%

The simulation algorithm then proceeds as follows: For each time step, the ODE
solver gets the current variable values and
calculates the system's state for the next time point. After that, events
and rules are processed, that can change the values. The modified values then
become the initial values for the next time step. The event processing of the
Rosenbrock solver
%\sout{is different from other solvers, as it}
is directly integrated in the solver class and influences the
step size. The time-accurate handling of events and rules leads to very precise
results of the simulation.
%
SED-ML support is enabled by inclusion of the \jlibsedml{} library
(\href{http://www.jlibsedml.org}{http://www.jlibsedml.org}) in the binary
download. Clients of the the Simulation Core Library can choose to use the
\jlibsedml{} API directly, or access SED-ML support via  facade classes
in the \texttt{org.simulator.sedml} package that do not require direct
dependencies on \jlibsedml{} in their code.


\section{Availability of supporting data}

\TODO{Website}

\bigskip

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Author's contributions}
   RK and AlD contributed equally.

    

%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Acknowledgements}
  \ifthenelse{\boolean{publ}}{\small}{}
The authors are grateful to B.~Kotcon, S.~Mesuro, D.~Rozenfeld, A.~Yodpinyanee,
A.~Perez, E.~Doi, R.~Mehlinger, S.~Ehrlich, M.~Hunt, G.~Tucker, P.~Scherpelz,
A.~Becker, E.~Harley, and C.~Moore, Harvey Mudd College, USA, for providing a
Java implementation of Rosenbrock's method, and to Michael T.~Cooling,
University of Auckland, New Zealand, for fruitful discussion.

This work was funded by the Federal Ministry of Education and Research (BMBF,
Germany) in the project Virtual Liver (grant number 0315756).
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                  The Bibliography                       %%
%%                                                         %%              
%%  Bmc_article.bst  will be used to                       %%
%%  create a .BBL file for submission, which includes      %%
%%  XML structured for BMC.                                %%
%%  After submission of the .TEX file,                     %%
%%  you will be prompted to submit your .BBL file.         %%
%%                                                         %%
%%                                                         %%
%%  Note that the displayed Bibliography will not          %% 
%%  necessarily be rendered by Latex exactly as specified  %%
%%  in the online Instructions for Authors.                %% 
%%                                                         %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
{\ifthenelse{\boolean{publ}}{\footnotesize}{\small}
 \bibliographystyle{bmc_article}  % Style BST file
  \bibliography{bmc_article} }     % Bibliography file (usually '*.bib' ) 

%%%%%%%%%%%

\ifthenelse{\boolean{publ}}{\end{multicols}}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               %%
%% Figures                       %%
%%                               %%
%% NB: this is for captions and  %%
%% Titles. All graphics must be  %%
%% submitted separately and NOT  %%
%% included in the Tex document  %%
%%                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%
%% Do not use \listoffigures as most will included as separate files

\section*{Figures}
  \subsection*{Figure 1 - Architecture of the Simulation Core Library
  (simplified)}
  
Numerical methods are strictly separated from differential equation systems. The
upper part displays the unified type hierarchy of all currently included numerical integration
methods. The middle part shows the interfaces defining several
special types of the differential equations to be solved by the numerical
methods.
The class \SBMLinterpreter{} (bottom part) implements all of these interfaces
with respect to the information content of a given SBML model. Similarly, an
implementation of further data formats can be included into the
library.

  \subsection*{Figure 2 - Sample figure title}
      Figure legend text.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               %%
%% Tables                        %%
%%                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Use of \listoftables is discouraged.
%%
\section*{Tables}

\TODO{Find criteria for a fair comparison of our approach with others.}
\TODO{Replace this table with a comparison table to other tools.}

  \subsection*{Table 1 - Sample table title}
    Here is an example of a \emph{small} table in \LaTeX\ using  
    \verb|\tabular{...}|. This is where the description of the table 
    should go. \par \mbox{}
    \par
    \mbox{
      \begin{tabular}{|c|c|c|}
        \hline \multicolumn{3}{|c|}{My Table}\\ \hline
        A1 & B2  & C3 \\ \hline
        A2 & ... & .. \\ \hline
        A3 & ..  & .  \\ \hline
      \end{tabular}
      }



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%                               %%
%% Additional Files              %%
%%                               %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Additional Files}
  \subsection*{Additional file 1 --- User Guide}
    \TODO{Briefly describe the content of the user guide.}

\end{bmcformat}
\end{document}







